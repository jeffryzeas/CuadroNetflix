<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factus ERP - Professional Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; }
        [v-cloak] { display: none; }
        
        /* Estilo de Factura Imprimible */
        .invoice-canvas {
            width: 210mm;
            min-height: 297mm;
            padding: 15mm;
            margin: 2rem auto;
            background: white;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            position: relative;
        }

        @media print {
            body * { visibility: hidden; }
            .invoice-canvas, .invoice-canvas * { visibility: visible; }
            .invoice-canvas { position: absolute; left: 0; top: 0; margin: 0; box-shadow: none; width: 100%; }
            .no-print { display: none !important; }
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="overflow-x-hidden">

<div id="app" v-cloak>
    <!-- LOGIN -->
    <div v-if="!isLoggedIn" class="min-h-screen flex items-center justify-center bg-slate-950 p-6">
        <div class="w-full max-w-md bg-white rounded-[2.5rem] p-10 shadow-2xl">
            <div class="text-center mb-10">
                <div class="inline-flex p-4 bg-blue-600 rounded-3xl text-white mb-4">
                    <i data-lucide="shield-check" class="w-10 h-10"></i>
                </div>
                <h1 class="text-3xl font-extrabold tracking-tighter">Factus ERP</h1>
                <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mt-2">Acceso Administrativo</p>
            </div>
            <div class="space-y-4">
                <input v-model="login.user" type="text" placeholder="Usuario" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
                <input v-model="login.pass" type="password" placeholder="Contraseña" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
                <button @click="handleLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl transition-all shadow-lg">INGRESAR AL SISTEMA</button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD PRINCIPAL -->
    <div v-else class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-900 text-white flex flex-col shrink-0">
            <div class="p-6 flex items-center gap-3 border-b border-slate-800">
                <i data-lucide="box" class="text-blue-500"></i>
                <span class="font-black text-xl">FACTUS</span>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <p class="text-[10px] font-bold text-slate-500 uppercase px-3 mb-2">Operaciones</p>
                <button @click="currentTab = 'bills'" :class="navBtnClass('bills')"><i data-lucide="file-text" class="w-4 h-4"></i> Facturas</button>
                <button @click="currentTab = 'support'" :class="navBtnClass('support')"><i data-lucide="file-check" class="w-4 h-4"></i> Doc. Soporte</button>
                <button @click="currentTab = 'create'" :class="navBtnClass('create')" class="!bg-blue-600 !mt-6"><i data-lucide="plus" class="w-4 h-4"></i> Nueva Factura</button>
            </nav>
            <div class="p-6 border-t border-slate-800">
                <button @click="isLoggedIn = false" class="text-slate-500 hover:text-white flex items-center gap-2 text-sm font-bold"><i data-lucide="log-out" class="w-4 h-4"></i> Salir</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 bg-white border-b border-slate-200 px-8 flex items-center justify-between">
                <h2 class="text-sm font-black uppercase tracking-widest text-slate-400">{{ currentTab }}</h2>
                <div class="flex items-center gap-4">
                    <button @click="loadData" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="refresh-cw" :class="{'animate-spin': loading}" class="w-4 h-4"></i></button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                
                <!-- LISTADO DE FACTURAS -->
                <div v-if="currentTab === 'bills' || currentTab === 'support'">
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50 text-[10px] font-black uppercase text-slate-400 border-b">
                                    <th class="px-6 py-4">Número</th>
                                    <th class="px-6 py-4">Cliente</th>
                                    <th class="px-6 py-4">Fecha</th>
                                    <th class="px-6 py-4 text-right">Monto</th>
                                    <th class="px-6 py-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <tr v-for="item in dataList" :key="item.number" class="hover:bg-slate-50 transition-all">
                                    <td class="px-6 py-4 font-bold text-blue-600 text-sm">{{ item.number }}</td>
                                    <td class="px-6 py-4">
                                        <div class="text-sm font-bold">{{ item.customer?.names || 'Cliente de Contado' }}</div>
                                        <div class="text-[10px] text-slate-400">{{ item.customer?.identification || '---' }}</div>
                                    </td>
                                    <td class="px-6 py-4 text-xs text-slate-500">{{ item.created_at }}</td>
                                    <td class="px-6 py-4 text-right font-black text-sm text-slate-900">{{ formatPrice(item.total) }}</td>
                                    <td class="px-6 py-4">
                                        <div class="flex justify-center gap-2">
                                            <button @click="viewInvoice(item)" class="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition-all" title="Ver Gráfica">
                                                <i data-lucide="eye" class="w-4 h-4"></i>
                                            </button>
                                            <button @click="viewJSON(item)" class="p-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-900 hover:text-white transition-all" title="Ver JSON">
                                                <i data-lucide="code" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div v-if="loading" class="p-20 flex flex-col items-center">
                            <div class="loader mb-4"></div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Sincronizando con Factus...</p>
                        </div>
                        <div v-if="!loading && dataList.length === 0" class="p-20 text-center">
                            <p class="text-slate-400 font-bold">No hay registros para mostrar.</p>
                        </div>
                    </div>
                </div>

                <!-- FORMULARIO CREACIÓN -->
                <div v-if="currentTab === 'create'" class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-xl p-10">
                        <h3 class="text-2xl font-black mb-8">Nueva Factura de Venta</h3>
                        <div class="grid grid-cols-2 gap-6 mb-8">
                            <div class="col-span-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase">Nombre del Cliente</label>
                                <input v-model="form.names" class="w-full mt-1 p-4 bg-slate-50 border rounded-2xl outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase">Identificación</label>
                                <input v-model="form.id" class="w-full mt-1 p-4 bg-slate-50 border rounded-2xl outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase">Email</label>
                                <input v-model="form.email" class="w-full mt-1 p-4 bg-slate-50 border rounded-2xl outline-none focus:border-blue-500">
                            </div>
                        </div>
                        
                        <div class="mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-sm font-black uppercase">Productos</h4>
                                <button @click="addItem" class="text-xs font-bold text-blue-600">+ Añadir</button>
                            </div>
                            <div v-for="(item, idx) in form.items" :key="idx" class="flex gap-4 mb-2">
                                <input v-model="item.name" placeholder="Producto" class="flex-1 p-3 bg-slate-50 border rounded-xl text-sm">
                                <input v-model.number="item.qty" type="number" class="w-20 p-3 bg-slate-50 border rounded-xl text-center font-bold">
                                <input v-model.number="item.price" type="number" class="w-32 p-3 bg-slate-50 border rounded-xl text-right font-bold">
                                <button @click="removeItem(idx)" class="text-red-400 px-2"><i data-lucide="x" class="w-4 h-4"></i></button>
                            </div>
                        </div>

                        <div class="flex items-center justify-between pt-6 border-t">
                            <div class="text-2xl font-black">{{ formatPrice(totalForm) }}</div>
                            <button @click="sendToFactus" :disabled="loading" class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-bold shadow-lg shadow-blue-200 disabled:opacity-50">
                                <span v-if="!loading">GENERAR FACTURA</span>
                                <span v-else>PROCESANDO...</span>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL VISOR GRÁFICO (REPRESENTACIÓN DEL JSON) -->
    <div v-if="modal.show" class="fixed inset-0 z-[100] bg-slate-900/95 backdrop-blur-md overflow-y-auto p-4 no-print">
        <div class="max-w-5xl mx-auto py-10">
            <div class="flex justify-between items-center mb-6 no-print">
                <h2 class="text-white font-black text-2xl">Representación Gráfica del JSON</h2>
                <div class="flex gap-3">
                    <button @click="window.print()" class="bg-white text-slate-900 px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-blue-50 transition-all">
                        <i data-lucide="printer" class="w-4 h-4"></i> Imprimir
                    </button>
                    <button @click="modal.show = false" class="bg-red-500 text-white p-3 rounded-xl"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
            </div>

            <!-- LIENZO DE LA FACTURA -->
            <div class="invoice-canvas rounded-lg">
                <div class="flex justify-between items-start mb-12 border-b-4 border-slate-900 pb-10">
                    <div class="flex items-center gap-6">
                        <div class="w-20 h-20 bg-slate-900 text-white flex items-center justify-center rounded-2xl">
                            <i data-lucide="layers" class="w-10 h-10"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-black text-slate-900 uppercase">SU LOGO AQUÍ S.A.S</h2>
                            <p class="text-xs font-bold text-slate-500">NIT: 900.000.000-1</p>
                            <p class="text-xs text-slate-400">Bogotá D.C, Colombia</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="bg-slate-900 text-white px-6 py-4 rounded-xl">
                            <p class="text-[10px] font-black uppercase tracking-widest text-blue-400">Factura de Venta</p>
                            <h3 class="text-2xl font-black">{{ modal.data.number }}</h3>
                        </div>
                        <p class="text-[10px] font-bold text-slate-500 mt-2 uppercase">Fecha: {{ modal.data.created_at || modal.data.date }}</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-10 mb-12">
                    <div>
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Adquiriente</h4>
                        <div class="space-y-1">
                            <p class="text-lg font-black text-slate-900">{{ modal.data.customer?.names || 'Cliente Genérico' }}</p>
                            <p class="text-sm font-bold text-slate-600">CC/NIT: {{ modal.data.customer?.identification }}</p>
                            <p class="text-sm text-slate-500">{{ modal.data.customer?.email }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Detalles</h4>
                        <p class="text-sm font-bold">Estado: <span class="text-green-600">VALIDADO POR LA DIAN</span></p>
                        <p class="text-sm">CUFE: <span class="text-[10px] font-mono break-all">{{ modal.data.uuid || 'N/A' }}</span></p>
                    </div>
                </div>

                <table class="w-full mb-10 border-collapse">
                    <thead>
                        <tr class="border-b-2 border-slate-900">
                            <th class="py-4 text-xs font-black uppercase text-left">Descripción</th>
                            <th class="py-4 text-xs font-black uppercase text-center w-20">Cant</th>
                            <th class="py-4 text-xs font-black uppercase text-right w-32">Unitario</th>
                            <th class="py-4 text-xs font-black uppercase text-right w-32">Total</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        <tr v-for="item in modal.data.items" :key="item.id">
                            <td class="py-4 text-sm">{{ item.name }}</td>
                            <td class="py-4 text-sm text-center">{{ item.quantity }}</td>
                            <td class="py-4 text-sm text-right font-medium">{{ formatPrice(item.price) }}</td>
                            <td class="py-4 text-sm text-right font-black">{{ formatPrice(item.price * item.quantity) }}</td>
                        </tr>
                    </tbody>
                </table>

                <div class="flex justify-end pt-6 border-t-2 border-slate-900">
                    <div class="w-72 space-y-3">
                        <div class="flex justify-between text-sm"><span class="text-slate-400 uppercase font-bold text-[10px]">Subtotal:</span> <span class="font-bold">{{ formatPrice(modal.data.total / 1.19) }}</span></div>
                        <div class="flex justify-between text-sm"><span class="text-slate-400 uppercase font-bold text-[10px]">IVA (19%):</span> <span class="font-bold">{{ formatPrice(modal.data.total - (modal.data.total / 1.19)) }}</span></div>
                        <div class="flex justify-between items-center pt-3 border-t border-slate-900">
                            <span class="font-black uppercase text-xs">Total Neto:</span>
                            <span class="text-2xl font-black text-slate-900">{{ formatPrice(modal.data.total) }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-20 flex items-center gap-6 opacity-30">
                    <i data-lucide="qr-code" class="w-20 h-20"></i>
                    <p class="text-[8px] font-bold uppercase max-w-xs leading-relaxed">Representación gráfica de factura electrónica generada por Factus ERP. Validada según normatividad vigente de la DIAN.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            api: {
                url: 'https://api-sandbox.factus.com.co',
                id: '9de9ec14-5684-48b5-baa3-9a87fc8c3c42',
                secret: 'bxKg2MEoRngRre8bpMWvH9JRLWan05sOofFghjcS',
                u: 'sandbox@factus.com.co',
                p: 'sandbox2024%'
            },
            isLoggedIn: false,
            login: { user: '', pass: '' },
            currentTab: 'bills',
            loading: false,
            dataList: [],
            form: {
                names: '', id: '', email: '',
                items: [{ name: '', qty: 1, price: 0 }]
            },
            modal: { show: false, data: {} }
        }
    },
    watch: {
        currentTab(v) { if(['bills', 'support'].includes(v)) this.loadData(); }
    },
    computed: {
        totalForm() { return this.form.items.reduce((acc, i) => acc + (i.qty * i.price * 1.19), 0); }
    },
    mounted() { lucide.createIcons(); },
    updated() { lucide.createIcons(); },
    methods: {
        handleLogin() { 
            if(this.login.user && this.login.pass) {
                this.isLoggedIn = true;
                this.loadData();
            }
        },
        async getToken() {
            const cache = JSON.parse(localStorage.getItem('factus_tk'));
            if(cache && Date.now() < cache.exp) return cache.token;

            try {
                const res = await fetch(`${this.api.url}/oauth/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({
                        grant_type: 'password',
                        client_id: this.api.id,
                        client_secret: this.api.secret,
                        username: this.api.u,
                        password: this.api.p
                    })
                });
                const d = await res.json();
                const obj = { token: d.access_token, exp: Date.now() + (d.expires_in * 1000) };
                localStorage.setItem('factus_tk', JSON.stringify(obj));
                return d.access_token;
            } catch(e) { return null; }
        },
        async loadData() {
            this.loading = true;
            this.dataList = [];
            try {
                const token = await this.getToken();
                const path = this.currentTab === 'bills' ? 'v1/bills' : 'v1/support-documents';
                const res = await fetch(`${this.api.url}/${path}`, {
                    headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' }
                });
                const d = await res.json();
                this.dataList = d.data?.data || d.data || [];
            } catch(e) { console.error(e); }
            finally { this.loading = false; }
        },
        async viewInvoice(item) {
            this.loading = true;
            try {
                const token = await this.getToken();
                // CONSULTA INDIVIDUAL PARA OBTENER TODO EL JSON (CON ITEMS)
                const res = await fetch(`${this.api.url}/v1/bills/show/${item.number}`, {
                    headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' }
                });
                const d = await res.json();
                if(d.data) {
                    this.modal.data = d.data;
                    this.modal.show = true;
                }
            } catch(e) { alert("Error obteniendo detalles del JSON."); }
            finally { this.loading = false; }
        },
        viewJSON(item) {
            const blob = new Blob([JSON.stringify(item, null, 4)], { type: 'application/json' });
            window.open(URL.createObjectURL(blob), '_blank');
        },
        async sendToFactus() {
            this.loading = true;
            try {
                const token = await this.getToken();
                const payload = {
                    "numbering_range_id": 8,
                    "reference_code": "ERP-" + Date.now(),
                    "customer": {
                        "identification": this.form.id,
                        "names": this.form.names,
                        "email": this.form.email,
                        "municipality_id": "149",
                        "identification_document_id": 3,
                        "type_document_identification_id": 1,
                        "type_organization_id": 2,
                        "type_regime_id": 2
                    },
                    "payment_form": "1",
                    "payment_method_id": "10",
                    "items": this.form.items.map(i => ({
                        "code_reference": "REF-" + Math.floor(Math.random()*999),
                        "name": i.name,
                        "quantity": i.qty,
                        "discount_rate": 0,
                        "price": i.price,
                        "tax_rate": "19.00",
                        "unit_measure_id": 70,
                        "standard_code_id": 1,
                        "is_excluded": 0,
                        "tribute_id": 1
                    }))
                };

                const res = await fetch(`${this.api.url}/v1/bills/validate`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`, 
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const d = await res.json();
                if(d.status === 'OK' || d.data) {
                    alert("¡Éxito! Factura validada por la DIAN.");
                    this.currentTab = 'bills';
                } else {
                    alert("Error DIAN: " + JSON.stringify(d.errors));
                }
            } catch(e) { alert("Fallo técnico."); }
            finally { this.loading = false; }
        },
        addItem() { this.form.items.push({ name: '', qty: 1, price: 0 }); },
        removeItem(idx) { if(this.form.items.length > 1) this.form.items.splice(idx, 1); },
        formatPrice(v) { return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(v); },
        navBtnClass(t) {
            const b = "w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-xs font-bold transition-all ";
            return b + (this.currentTab === t ? "bg-slate-800 text-white" : "text-slate-500 hover:text-white hover:bg-slate-800");
        }
    }
}).mount('#app');
</script>
</body>
</html>

